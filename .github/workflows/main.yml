name: Run Xray (VLESS) in GitHub Actions

on:
  workflow_dispatch:  # Запуск вручную

jobs:
  run-xray:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # Ограничение в 6 часов

    steps:
      - name: Установка зависимостей
        run: |
          sudo apt update
          sudo apt install -y curl unzip

      - name: Установка Xray
        run: |
          curl -Lo xray.zip https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip xray.zip -d xray
          chmod +x xray/xray

      - name: Генерация UUID
        run: echo "UUID=$(cat /proc/sys/kernel/random/uuid)" >> $GITHUB_ENV

      - name: Создание конфигурации Xray
        run: |
          cat <<EOF > config.json
          {
            "inbounds": [
              {
                "port": 8080,
                "protocol": "vless",
                "settings": {
                  "clients": [
                    {
                      "id": "$UUID",
                      "flow": "xtls-rprx-vision"
                    }
                  ],
                  "decryption": "none"
                },
                "streamSettings": {
                  "network": "ws",
                  "wsSettings": {
                    "path": "/vless"
                  }
                }
              }
            ],
            "outbounds": [
              {
                "protocol": "freedom",
                "settings": {}
              }
            ]
          }
          EOF

      - name: Установка Cloudflare Tunnel
        run: |
          curl -fsSL https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared

      - name: Запуск Xray и Cloudflare Tunnel
        run: |
          nohup ./xray/xray -c config.json > xray.log 2>&1 &
          nohup ./cloudflared tunnel --url http://localhost:8080 > tunnel.log 2>&1 &
          sleep 5  # Даем время Cloudflare запуститься
          echo "TUNNEL_URL=$(grep -o 'https://.*trycloudflare.com' tunnel.log | head -1)" >> $GITHUB_ENV

      - name: Вывод информации
        run: |
          echo "### VLESS Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **UUID:** $UUID" >> $GITHUB_STEP_SUMMARY
          echo "- **Tunnel URL:** $TUNNEL_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Port:** 443" >> $GITHUB_STEP_SUMMARY
          echo "- **WebSocket Path:** /vless" >> $GITHUB_STEP_SUMMARY
          
      - name: Удержание процесса активным
        run: tail -f /dev/null
